{% extends 'base.html' %}

{% block content %}
<div class="level">
  <div class="level-left">
    <div class="level-item">
      <h1 class="title is-3">AI Generator (Demo)</h1>
    </div>
  </div>
</div>

<div class="box">
  <form id="gen-form" method="post" action="{% url 'editor:generator_create' %}">
    {% csrf_token %}
    <div class="field">
      <label class="label">Prompt</label>
      <div class="control">
        <textarea class="textarea" name="prompt" placeholder="Describe the image you want..."></textarea>
      </div>
    </div>

    <div class="field">
      <label class="label">Negative prompt (optional)</label>
      <div class="control">
        <input class="input" name="negative_prompt" placeholder="Things to avoid...">
      </div>
    </div>

    <div class="field">
      <label class="label">Model (optional)</label>
      <div class="control">
        <input class="input" name="model" placeholder="stabilityai/stable-diffusion-2">
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-body">
        <div class="field">
          <label class="label">Count</label>
          <div class="control">
            <input class="input" name="count" type="number" value="1" min="1" max="6">
          </div>
        </div>
        <div class="field">
          <label class="label">Size</label>
          <div class="control">
            <div class="select">
              <select name="size">
                <option>512x512</option>
                <option>768x768</option>
                <option>1024x1024</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label">Seed (optional)</label>
          <div class="control">
            <input class="input" name="seed" type="number" placeholder="Random seed (optional)">
          </div>
        </div>
      </div>
    </div>

    <div class="field">
      <div class="control">
        <button id="gen-btn" class="button is-primary" type="submit">Generate</button>
      </div>
    </div>
  </form>
</div>

<h2 class="subtitle">Recent generated images</h2>
<div id="gen-results" class="columns is-multiline">
  {% for a in recent %}
  <div class="column is-one-quarter">
    <div class="card">
      <div class="card-image">
        <figure class="image is-4by3">
          <img src="{{ a.image.url }}" alt="{{ a.title }}">
        </figure>
      </div>
      <div class="card-content">
        <div class="content">
          <p class="is-6">{{ a.title }}</p>
          <a class="button is-small" href="{% url 'editor:edit' a.id %}">Edit</a>
          <button class="button is-small regen-btn" data-asset-id="{{ a.id }}">Regenerate</button>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="column">
    <div class="notification is-info">No generated images yet.</div>
  </div>
  {% endfor %}
</div>

<script>
document.getElementById('gen-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const btn = document.getElementById('gen-btn');
  btn.classList.add('is-loading');

  const resp = await fetch(form.action, {
    method: 'POST',
    headers: {'X-Requested-With': 'XMLHttpRequest'},
    body: data
  });

  btn.classList.remove('is-loading');

  if (!resp.ok) {
    const text = await resp.text();
    alert('Generation failed: ' + text.substring(0, 200));
    return;
  }

  const j = await resp.json();
  if (j.status === 'enqueued') {
    pollJob(j.job_id);
  } else if (j.status === 'done') {
    renderResults(j.results);
  } else {
    alert('Unexpected response: ' + JSON.stringify(j));
  }
});

function renderResults(urls) {
  const container = document.getElementById('gen-results');
  for (const u of urls) {
    const col = document.createElement('div'); col.className = 'column is-one-quarter';
    col.innerHTML = `
      <div class="card">
        <div class="card-image"><figure class="image is-4by3"><img src="${u}"/></figure></div>
        <div class="card-content"><div class="content"><a class="button is-small" href="${u}" target="_blank">Open</a></div></div>
      </div>`;
    container.insertBefore(col, container.firstChild);
  }
}

// CSRF helper for AJAX
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

// Attach click handlers for regenerate buttons (existing cards)
function attachRegenHandlers() {
  document.querySelectorAll('.regen-btn').forEach(btn => {
    btn.removeEventListener('click', onRegenClick);
    btn.addEventListener('click', onRegenClick);
  });
}

async function onRegenClick(e) {
  const btn = e.currentTarget;
  const assetId = btn.getAttribute('data-asset-id');
  if (!assetId) return;
  btn.classList.add('is-loading');
  const url = `{% url 'editor:regenerate_preview' 0 %}`.replace('/0/', '/' + assetId + '/');
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    if (!resp.ok) throw new Error('Request failed');
    const j = await resp.json();
    if (j.status === 'ok' && j.url) {
      // update image element in the same card
      const card = btn.closest('.card');
      if (card) {
        const img = card.querySelector('img');
        if (img) {
          img.src = j.url + (j.url.indexOf('?') === -1 ? '?' : '&') + 'v=' + Date.now();
        }
      }
    } else {
      alert('Regeneration failed: ' + (j.message || JSON.stringify(j)));
    }
  } catch (err) {
    alert('Regeneration error: ' + err.message);
  } finally {
    btn.classList.remove('is-loading');
  }
}

// run on initial load
attachRegenHandlers();

async function pollJob(jobId) {
  const statusUrl = `{% url 'editor:generator_status' 0 %}`.replace('/0/', '/' + jobId + '/');
  const spinner = document.createElement('div'); spinner.className = 'notification is-info'; spinner.textContent = 'Waiting for generation...';
  const container = document.getElementById('gen-results');
  container.insertBefore(spinner, container.firstChild);

  for (let i=0;i<60;i++) {
    const r = await fetch(statusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
    if (!r.ok) break;
    const j = await r.json();
    if (j.completed) {
      spinner.remove();
      renderResults(j.results || []);
      return;
    }
    await new Promise(res => setTimeout(res, 1000));
  }
  spinner.textContent = 'Generation is taking longer than expected. Reload the page to see results.';
}
</script>

{% endblock %}
